<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω H·ªì s∆°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        :root {
            --bg-body: #ffffff; --primary-color: #0061d5; --text-main: #2c3e50;
            --text-sub: #546e7a; --border-color: #e0e0e0; --accent-color: #d93025; --row-hover: #f8fbff;
            /* Colors from Modal */
            --u-bg: #f4f7f9; --u-border: #dcdfe6; --u-focus: #004fb0;
        }
        body {
            margin: 0; padding: 0; background: var(--bg-body);
            font-family: 'Segoe UI', Roboto, sans-serif;
            color: var(--text-main); width: 100%; overflow-x: hidden;
        }
        .main-wrapper { width: 100%; padding: 0 30px; }
        /* --- HEADER & ICONS --- */
        .header-flex { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .nav-group { display: flex; align-items: center; gap: 10px; }
        .safe-right { margin-right: 40px !important; }
        .search-inline {
            display: flex; align-items: center; background: #f1f3f4;
            border-radius: 4px; padding: 4px 8px; width: 220px; border: 1px solid transparent;
        }
        .search-inline input { border: none; background: transparent; width: 100%; outline: none; font-size: 13px; }
        .icon-btn { cursor: pointer; font-size: 18px; transition: 0.2s; color: var(--primary-color); }
        .icon-btn:hover { transform: scale(1.1); opacity: 0.8; }
        .logout-btn { color: #999; margin-left: 10px; }
        .logout-btn:hover { color: var(--accent-color); }
        .upload-btn { color: #455a64; font-size: 20px; }
        /* User Badge */
        .user-control { display: none; align-items: center; gap: 10px; }
        .user-badge { display: flex; align-items: center; gap: 8px; background: #f0f7ff; padding: 3px 10px; border-radius: 20px; border: 1px solid #cce3ff; }
        .user-badge span { font-size: 13px; font-weight: 600; color: var(--primary-color); }
        .user-avatar-mini { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; }
        /* --- TABLE STYLE --- */
        .table-l1 { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .table-l1 thead th {
            position: sticky; top: 0; z-index: 1000; background: #fff;
            color: var(--text-sub); font-weight: 600; text-transform: uppercase;
            font-size: 12px; padding: 15px; text-align: left;
            border-bottom: 2px solid var(--primary-color); border-right: 1px solid #f0f0f0;
        }
        .resizer { position: absolute; right: 0; top: 0; width: 4px; height: 100%; cursor: col-resize; }
        .row-folder { cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: 0.2s; }
        .row-folder:hover { background: var(--row-hover); }
        .row-folder td { padding: 12px 10px; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .active-f { background: #f0f7ff !important; font-weight: 600; border-left: 4px solid var(--primary-color); }
        /* --- MODAL COMMON --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        /* LOGIN MODAL SPECIFIC */
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 320px; position: relative; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .pass-wrapper { position: relative; }
        .toggle-icon { position: absolute; right: 10px; top: 22px; cursor: pointer; color: #888; }
        .modal-btn { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .modal-btn:disabled { background: #ccc; cursor: not-allowed; }
        /* Spinner CSS */
        .spinner-mini { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 8px; }
        /* --- UPLOAD MODAL STYLE --- */
        .u-container {
            background: #fff; width: 95%; max-width: 900px; padding: 30px;
            border-radius: 12px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); position: relative;
        }
        .u-header { border-bottom: 2px solid var(--primary-color); margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .u-header h2 { margin: 0; color: var(--primary-color); font-size: 18px; text-transform: uppercase; }
        .u-user-info { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; background: #f4f6f8; padding: 5px 12px; border-radius: 20px; }
        .u-user-info img { width: 20px; height: 20px; border-radius: 50%; }
        .grid-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #5a5e66; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid var(--u-border); border-radius: 5px; font-size: 14px; outline: none; color: var(--text-main); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary-color); }
        .content-file-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: stretch; }
        .content-file-row > div { flex: 1; display: flex; flex-direction: column; }
        .textarea-box { height: 140px; resize: none; }
        /* Upload Zone */
        .upload-container {
            flex: 1; border: 2px dashed var(--primary-color); background: #f0f7ff;
            border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px; transition: 0.2s;
        }
        .upload-container.dragover { background: #d1e7ff; }
        .upload-container.has-file { border-style: solid; background: #e8f5e9; border-color: #4caf50; }
        .upload-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-mini { padding: 6px 12px; font-size: 11px; background: #fff; border: 1px solid var(--primary-color); color: var(--primary-color); border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-mini:hover { background: var(--primary-color); color: #fff; }
        .footer-row { display: flex; align-items: center; gap: 15px; border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px; }
        .footer-row input { flex: 1; padding: 10px 12px; border: 1px solid var(--u-border); border-radius: 5px; font-size: 14px; outline: none; color: var(--text-main); }
        .footer-row input:focus { border-color: var(--primary-color); }
        .btn-main-box { display: flex; gap: 10px; }
        .btn-save { background: var(--primary-color); color: #fff; border: none; padding: 10px 20px; border-radius: 5px; font-weight: 700; cursor: pointer; font-size: 13px; opacity: 1; transition: 0.3s; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
        .btn-reset { background: #f4f4f5; color: #606266; border: none; padding: 10px 20px; border-radius: 5px; font-weight: 700; cursor: pointer; font-size: 13px; }
        /* --- LEVEL 2 & 3 --- */
        .l2-box { background: #fafafa; padding: 10px; border-bottom: 1px solid #eee; }
        .period-item { background: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .p-title { color: var(--accent-color); font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .l3-container { width: 100%; overflow: auto; max-height: 50vh; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; }
        .table-l3 { width: max-content; min-width: 100%; border-collapse: collapse; }
        .table-l3 th { position: sticky; top: 0; background: #f1f3f4; padding: 8px 10px; font-size: 12px; border-right: 1px solid #e0e0e0; border-bottom: 2px solid #d0d0d0; text-align: left; white-space: nowrap; }
        .table-l3 td { padding: 8px 10px; border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toast-custom { margin-bottom: 75px !important; border-radius: 8px !important; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; }
        .loader { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        /* Checkbox group style */
        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--u-border);
            border-radius: 5px;
            padding: 8px;
            background: #fff;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        /* Multi-select style */
        .multi-select {
            position: relative;
        }
        .select-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border: 1px solid var(--u-border);
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-main);
        }
        .select-box:focus {
            border-color: var(--primary-color);
        }
        .selected-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .options-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--u-border);
            border-radius: 5px;
            background: #fff;
            z-index: 10;
            display: none;
            padding: 8px;
        }
        .options-container .checkbox-item {
            padding: 4px 0;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
    <div id="loginModal" class="modal-overlay">
        <div class="login-box">
            <h3 style="text-align:center; margin-top:0;">ƒêƒÇNG NH·∫¨P</h3>
            <div id="loginFormContent">
                <input type="text" id="modalUser" placeholder="T√†i kho·∫£n">
                <div class="pass-wrapper">
                    <input type="password" id="modalPass" placeholder="M·∫≠t kh·∫©u">
                    <i class="fa-solid fa-eye toggle-icon" id="eyeIcon" onclick="togglePass()"></i>
                </div>
                <button id="btnLoginAction" class="modal-btn" onclick="processLogin()">X√ÅC NH·∫¨N</button>
            </div>
            <p id="loginStatus" style="color:red; font-size:12px; text-align:center; display:none; margin-bottom:0;"></p>
            <button class="modal-btn" style="background:#999; margin-top:10px;" onclick="closeLogin()">H·ª¶Y</button>
        </div>
    </div>
    <div id="uploadModal" class="modal-overlay">
        <div class="u-container">
            <div class="u-header">
                <h2>Phi·∫øu Nh·∫≠p H·ªì S∆° VƒÉn B·∫£n</h2>
                <div id="modalUserHeader" class="u-user-info" style="display:none;">
                    <img src="" alt="">
                    <span></span>
                </div>
            </div>
            <form id="profileForm">
                <input type="hidden" data-col="ProfileID" id="u_profileId">
                <input type="hidden" data-col="TimeUpdate" id="u_updateTime">
                <input type="hidden" data-col="AccountUpdate" id="u_account">
                <div class="grid-row">
                    <div class="form-group">
                        <label>H·ªì s∆° (Folder) * (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                        <div class="multi-select req-input">
                            <div class="select-box" onclick="toggleDropdown(this)">
                                <span class="selected-text">Ch·ªçn h·ªì s∆°...</span>
                                <i class="fa-solid fa-chevron-down"></i>
                            </div>
                            <div id="folderOptions" class="options-container"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Giai ƒëo·∫°n *</label>
                        <select id="periodSelect" class="req-input" data-col="PeriodID" required></select>
                    </div>
                </div>
                <div class="grid-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Lo·∫°i vƒÉn b·∫£n *</label>
                        <select id="typeSelect" class="req-input" data-col="DocTypeID" required></select>
                    </div>
                    <div class="form-group">
                        <label>S·ªë k√Ω hi·ªáu</label>
                        <input type="text" data-col="SymbolString" placeholder="VD: 01/Qƒê-UB">
                    </div>
                    <div class="form-group">
                        <label>Ng√†y ban h√†nh</label>
                        <input type="date" data-col="PromulgateDate">
                    </div>
                </div>
                <div class="grid-row">
                    <div class="form-group">
                        <label>C∆° quan ban h√†nh</label>
                        <select id="orgSelect" data-col="OrganizationID"></select>
                    </div>
                    <div class="form-group">
                        <label>Ng∆∞·ªùi k√Ω</label>
                        <input type="text" data-col="AccountSigner">
                    </div>
                </div>
                <div class="content-file-row">
                    <div class="form-group">
                        <label>Tr√≠ch y·∫øu n·ªôi dung *</label>
                        <textarea id="abstractInput" data-col="Abstract" class="textarea-box req-input" placeholder="Nh·∫≠p t√≥m t·∫Øt vƒÉn b·∫£n..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>ƒê√≠nh k√®m file *</label>
                        <div class="upload-container" id="dropzone">
                            <i class="fa-solid fa-cloud-arrow-up" style="font-size: 28px; color: var(--primary-color); margin-bottom:5px;"></i>
                            <span style="font-size: 12px; color: var(--primary-color); font-weight: bold;">K√âO TH·∫¢ FILE V√ÄO ƒê√ÇY</span>
                            <div class="upload-actions">
                                <button type="button" class="btn-mini" onclick="document.getElementById('fileInput').click()">CH·ªåN T·ª™ M√ÅY</button>
                                <button type="button" class="btn-mini" onclick="window.open('https://drive.google.com/drive/u/0/my-drive', '_blank')">GOOGLE DRIVE</button>
                            </div>
                            <div id="file-status" style="margin-top:8px; font-size:12px; color:#555;">Ch∆∞a c√≥ file n√†o</div>
                            <input type="file" id="fileInput" class="req-input" style="display: none;">
                        </div>
                    </div>
                </div>
                <div class="footer-row">
                    <label>Ghi ch√∫:</label>
                    <input type="text" data-col="Note" placeholder="Th√¥ng tin b·ªï sung...">
                    <div class="btn-main-box">
                        <button type="button" class="btn-reset" onclick="closeUploadModal()">ƒê√ìNG</button>
                        <button type="submit" class="btn-save" id="btnSubmit" disabled>L∆ØU H·ªí S∆†</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="main-wrapper">
        <table class="table-l1">
            <thead id="headerL1"></thead>
            <tbody id="bodyL1"></tbody>
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const UI_CONFIG = {
            SHEETS: { folder: 'Folder', profile: 'Profile', period: 'Period', doctype: 'DocType', org: 'Organization' },
            L1_COLUMNS: [
                { label: "H·ªì S∆°", key: "foldername", width: "60%" },
                { label: "Ghi Ch√∫", key: "note", width: "40%" }
            ],
            L3_COLUMNS: [
                { label: "", key: "download", width: "50px" },
                { label: "ID H·ªì s∆°", key: "profileid", width: "100px" },
                { label: "Giai ƒêo·∫°n", key: "periodid", width: "150px" },
                { label: "Lo·∫°i VƒÉn B·∫£n", key: "doctypeid", width: "150px" },
                { label: "S·ªë K√Ω Hi·ªáu", key: "symbolstring", width: "140px" },
                { label: "Ng√†y Ban H√†nh", key: "promulgatedate", width: "120px" },
                { label: "Tr√≠ch Y·∫øu N·ªôi Dung", key: "abstract", width: "250px" },
                { label: "C∆° Quan Ban H√†nh", key: "organizationid", width: "200px" },
                { label: "Ng∆∞·ªùi K√Ω", key: "accountsigner", width: "120px" },
                { label: "File ID", key: "fileid", width: "120px" },
                { label: "Ng∆∞·ªùi c·∫≠p nh·∫≠t", key: "accountupdate", width: "120px" },
                { label: "Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t", key: "timeupdate", width: "150px" }
            ]
        };
        const SPREADSHEET_ID = '1W9UGPV9g_WmKHFsD2DRB5_aj3dHmZ_AySAyhC5xtnz0';
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyeEWVK5f00MUvGokP72eCTvhZRCMujj_fVgsArNo0WJ0CtS2i6qZ-Mm2REK9SfiJbx/exec";
        let DATA_STORE = { folders: [], profiles: [], periods: {}, types: {}, orgs: {}, rawPeriods: [], rawTypes: [], rawOrgs: [] };
        let filteredData = [];
        let expandedF = null, expandedP = null;
        let currentUser = null;
        let openDropdown = null;
        async function bootstrap() {
            try {
                const fetchers = Object.values(UI_CONFIG.SHEETS).map(name => fetchGoogleSheet(name));
                const results = await Promise.all(fetchers);
                
                const [fData, pData, perData, typeData, orgData] = results;
                
                DATA_STORE.folders = fData;
                DATA_STORE.profiles = pData;
                DATA_STORE.rawPeriods = perData;
                DATA_STORE.rawTypes = typeData;
                DATA_STORE.rawOrgs = orgData;
                perData.forEach(r => { if(id(r, 'period')) DATA_STORE.periods[id(r, 'period')] = r[findKey(r, 'periodname')]; });
                typeData.forEach(r => { if(id(r, 'doctype')) DATA_STORE.types[id(r, 'doctype')] = r[findKey(r, 'doctypename')]; });
                orgData.forEach(r => { if(id(r, 'organization')) DATA_STORE.orgs[id(r, 'organization')] = r[findKey(r, 'organizationname')]; });
                filteredData = [...DATA_STORE.folders];
                renderHeaderL1();
                renderFolders();
                checkSession();
                setupUploadModal();
            } catch (err) {
                console.error(err);
                alert("L·ªói t·∫£i d·ªØ li·ªáu: " + err.message);
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        }
        async function fetchGoogleSheet(name) {
            const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(name)}`;
            const res = await fetch(url); const text = await res.text(); return parseCSVRobust(text);
        }
        function parseCSVRobust(text) {
            const rows = []; const re = /"((?:""|[^"])*)"|([^,\r\n]+)|(,|\r|\n)/g;
            let curr = []; let m;
            while ((m = re.exec(text + "\n"))) {
                let [full, q, u, d] = m;
                if (q !== undefined) curr.push(q.replace(/""/g, '"'));
                else if (u !== undefined) curr.push(u);
                else if (d === ',') { if (m.index === re.lastIndex - 1) curr.push(""); }
                else { rows.push(curr); curr = []; }
            }
            if (rows.length === 0) return [];
            const headers = rows[0].map(h => h.toLowerCase().replace(/\s+/g, ''));
            return rows.slice(1).filter(r => r.length > 0).map(row => {
                let o = {}; headers.forEach((h, i) => o[h] = row[i] || ""); return o;
            });
        }
        const norm = (s) => (s || "").toString().toLowerCase().replace(/\s+/g, '');
        const findKey = (obj, t) => {
            const nt = norm(t); return Object.keys(obj).find(k => norm(k) === nt) || Object.keys(obj).find(k => norm(k).includes(nt)) || nt;
        };
        const id = (obj, type) => obj[findKey(obj, type + 'id')] || "";
        function renderHeaderL1() {
            const head = document.getElementById('headerL1');
            let html = `<tr>`;
            UI_CONFIG.L1_COLUMNS.forEach(c => {
                let content = c.label;
                if(c.key === 'foldername') {
                    content = `<div class="header-flex"><span>${c.label}</span><div class="nav-group">
                        <i class="fa-solid fa-cloud-arrow-up icon-btn upload-btn" title="Upload h·ªì s∆°" onclick="handleUploadClick()"></i>
                        <div class="search-inline"><input type="text" id="searchInput" placeholder="T√¨m ki·∫øm nhanh...">
                        <i class="fa-solid fa-magnifying-glass" style="color:#999; font-size:12px;"></i></div></div></div>`;
                }
                if(c.key === 'note') {
                    content = `<div class="header-flex"><span>${c.label}</span><div class="nav-group safe-right">
                        <i class="fa-solid fa-circle-user icon-btn" id="loginBtn" onclick="openLogin()" title="ƒêƒÉng nh·∫≠p"></i>
                        <i class="fa-solid fa-right-from-bracket icon-btn logout-btn" id="logoutBtn" style="display:none" onclick="processLogout()" title="ƒêƒÉng xu·∫•t"></i>
                        <div id="userBadge" class="user-control"><div class="user-badge"><img id="uAvatar" class="user-avatar-mini" src=""><span id="uName"></span></div></div></div></div>`;
                }
                html += `<th style="width:${c.width}">${content}<div class="resizer"></div></th>`;
            });
            head.innerHTML = html + `</tr>`;
            attachResizers();
            document.getElementById('searchInput').oninput = (e) => {
                const q = norm(e.target.value);
                filteredData = DATA_STORE.folders.filter(f => norm(f[findKey(f, 'foldername')]).includes(q));
                renderFolders();
            };
        }
        function renderFolders() {
            const body = document.getElementById('bodyL1'); body.innerHTML = '';
            filteredData.forEach(f => {
                const fid = id(f, 'folder');
                const tr = document.createElement('tr');
                tr.className = `row-folder ${expandedF === fid ? 'active-f' : ''}`;
                tr.innerHTML = UI_CONFIG.L1_COLUMNS.map(c => `<td>${f[findKey(f, c.key)]}</td>`).join('');
                tr.onclick = () => { expandedF = (expandedF === fid) ? null : fid; expandedP = null; renderFolders(); };
                body.appendChild(tr);
                if (expandedF === fid) {
                    const cTr = document.createElement('tr'); const td = document.createElement('td');
                    td.colSpan = UI_CONFIG.L1_COLUMNS.length; td.className = 'l2-box';
                    const fProfiles = DATA_STORE.profiles.filter(p => {
                        const folderIdsStr = id(p, 'folder') || "";
                        const folderIds = folderIdsStr.split(',').map(s => s.trim());
                        return folderIds.includes(fid);
                    });
                    const periods = [...new Set(fProfiles.map(p => id(p, 'period')))];
                    periods.forEach(pid => {
                        const pDiv = document.createElement('div'); pDiv.className = `period-item`;
                        pDiv.innerHTML = `<span class="p-title">üìÅ ${DATA_STORE.periods[pid] || pid}</span> <span>${expandedP === pid ? '‚ñº' : '‚ñ∂'}</span>`;
                        pDiv.onclick = (e) => { e.stopPropagation(); expandedP = (expandedP === pid) ? null : pid; renderFolders(); };
                        td.appendChild(pDiv);
                        if (expandedP === pid) {
                            const l3c = document.createElement('div'); l3c.className = 'l3-container';
                            let h = `<table class="table-l3"><thead><tr>`;
                            UI_CONFIG.L3_COLUMNS.forEach(c => {
                                const hidden = ['fileid', 'accountupdate', 'timeupdate'].includes(c.key);
                                h += `<th style="width:${c.width}${hidden ? ';display:none' : ''}">${c.label}</th>`;
                            });
                            h += `</tr></thead><tbody>`;
                            fProfiles.filter(p => id(p, 'period') === pid).forEach(prof => {
                                h += `<tr>`;
                                UI_CONFIG.L3_COLUMNS.forEach(c => {
                                    if(c.key === 'download') {
                                        let fileId = prof[findKey(prof, 'fileid')];
                                        if(fileId) {
                                            let action = `window.open('https://drive.google.com/file/d/${fileId}/view', '_blank')`;
                                            h += `<td style="text-align:center;"><i class="fa-solid fa-file-arrow-down icon-btn" onclick="${action}" title="T·∫£i file"></i></td>`;
                                        } else h += `<td></td>`;
                                    } else {
                                        let v = prof[findKey(prof, c.key)] || "";
                                        if (c.key === 'periodid') v = DATA_STORE.periods[v] || v;
                                        if (c.key === 'doctypeid') v = DATA_STORE.types[v] || v;
                                        if (c.key === 'organizationid') v = DATA_STORE.orgs[v] || v;
                                        const hidden = ['fileid', 'accountupdate', 'timeupdate'].includes(c.key);
                                        h += `<td title="${v}" style="${hidden ? 'display:none;' : ''}">${v}</td>`;
                                    }
                                });
                                h += `</tr>`;
                            });
                            l3c.innerHTML = h + `</tbody></table>`; td.appendChild(l3c);
                        }
                    });
                    cTr.appendChild(td); body.appendChild(cTr);
                }
            });
        }
        function openLogin() { document.getElementById('loginModal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }
        function togglePass() {
            const p = document.getElementById('modalPass'); const i = document.getElementById('eyeIcon');
            p.type = p.type === 'password' ? 'text' : 'password';
            i.classList.toggle('fa-eye'); i.classList.toggle('fa-eye-slash');
        }
        async function processLogin() {
            const u = document.getElementById('modalUser'); const p = document.getElementById('modalPass');
            const btn = document.getElementById('btnLoginAction'); const st = document.getElementById('loginStatus');
            if(!u.value || !p.value) { st.innerText = "Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin"; st.style.display = 'block'; return; }
            btn.disabled = true; btn.innerHTML = `<div class="spinner-mini"></div> ƒêANG KI·ªÇM TRA...`;
            try {
                const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "login", username: u.value, password: p.value }) });
                const r = await res.json();
                if(r.success) {
                    localStorage.setItem("userSession", JSON.stringify(r.data));
                    updateUI(r.data); closeLogin(); showToast("Ch√†o m·ª´ng " + r.data.name + "!", "success");
                    u.value = ""; p.value = "";
                } else { st.innerText = r.message; st.style.display = "block"; }
            } catch(e) { st.innerText = "L·ªói k·∫øt n·ªëi m√°y ch·ªß!"; st.style.display = "block"; }
            finally { btn.disabled = false; btn.innerHTML = "X√ÅC NH·∫¨N"; }
        }
        function processLogout() {
            localStorage.removeItem("userSession"); currentUser = null;
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('userBadge').style.display = 'none';
            showToast("ƒê√£ ƒëƒÉng xu·∫•t", "info");
        }
        function checkSession() {
            const s = localStorage.getItem("userSession"); if(s) updateUI(JSON.parse(s));
        }
        function updateUI(data) {
            currentUser = data;
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('userBadge').style.display = 'flex';
            document.getElementById('uName').innerText = data.name;
            document.getElementById('uAvatar').src = data.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        }
        function handleUploadClick() {
            if(!currentUser) { showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p!", "error"); openLogin(); }
            else openUploadModal();
        }
        function openUploadModal() {
            const mh = document.getElementById('modalUserHeader'); mh.style.display = 'flex';
            mh.querySelector('img').src = currentUser.avatar || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            mh.querySelector('span').innerText = currentUser.name;
            document.getElementById('uploadModal').style.display = 'flex';
        }
        function closeUploadModal() { document.getElementById('uploadModal').style.display = 'none'; }
        function setupUploadModal() {
            // Fill c√°c select kh√°c
            const fillSelect = (id, list, lblKey, valKey) => {
                const el = document.getElementById(id); el.innerHTML = `<option value="">-- Ch·ªçn --</option>`;
                list.forEach(i => {
                    const txt = i[findKey(i, lblKey)]; const val = i[findKey(i, valKey)];
                    if(txt) el.add(new Option(txt, val));
                });
            };
            fillSelect('periodSelect', DATA_STORE.rawPeriods, 'periodname', 'periodid');
            fillSelect('typeSelect', DATA_STORE.rawTypes, 'doctypename', 'doctypeid');
            fillSelect('orgSelect', DATA_STORE.rawOrgs, 'organizationname', 'organizationid');
            // Fill checkbox cho Folder
            const checkboxGroup = document.getElementById('folderOptions');
            checkboxGroup.innerHTML = '';
            DATA_STORE.folders.forEach(folder => {
                const folderName = folder[findKey(folder, 'foldername')];
                const folderId = folder[findKey(folder, 'folderid')];
                if (folderName && folderId) {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `<input type="checkbox" name="folderCheckbox" value="${folderId}"> <label>${folderName}</label>`;
                    checkboxGroup.appendChild(div);
                }
            });
            const selectedText = document.querySelector('.selected-text');
            function updateSelectedText() {
                const checked = Array.from(checkboxGroup.querySelectorAll('input:checked'));
                selectedText.innerText = checked.length > 0 ? checked.map(cb => cb.nextElementSibling.innerText).join(', ') : 'Ch·ªçn h·ªì s∆°...';
            }
            checkboxGroup.addEventListener('change', () => {
                updateSelectedText();
                validateUploadForm();
            });
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('fileInput');
            const fileStatus = document.getElementById('file-status');
            
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault(); dropzone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) { fileInput.files = e.dataTransfer.files; updateFileStatus(e.dataTransfer.files[0].name); }
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) updateFileStatus(e.target.files[0].name); });
            function updateFileStatus(name) {
                fileStatus.innerText = "üìÅ File: " + name; fileStatus.style.color = "#0061d5"; fileStatus.style.fontWeight = "bold";
                dropzone.classList.add('has-file'); validateUploadForm();
            }
            // Validate khi thay ƒë·ªïi checkbox ho·∫∑c c√°c field kh√°c
            const reqInputs = document.querySelectorAll('.req-input');
            reqInputs.forEach(el => {
                el.addEventListener('input', validateUploadForm);
                el.addEventListener('change', validateUploadForm);
            });
        }
        function validateUploadForm() {
            const checkedFolders = document.querySelectorAll('#folderOptions input[type="checkbox"]:checked');
            const period = document.getElementById('periodSelect').value;
            const type = document.getElementById('typeSelect').value;
            const abstract = document.getElementById('abstractInput').value;
            const hasFile = document.getElementById('fileInput').files.length > 0;
            const hasFolder = checkedFolders.length > 0;
            const btn = document.getElementById('btnSubmit');
            btn.disabled = !(hasFolder && period && type && abstract && hasFile);
        }
        document.getElementById('profileForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true; btn.innerText = "ƒêANG L∆ØU...";
            const checkedFolders = document.querySelectorAll('#folderOptions input[type="checkbox"]:checked');
            const selectedFolderIds = Array.from(checkedFolders).map(cb => cb.value).join(',');
            const orgId = document.getElementById('orgSelect').value || "";
            const nnnnn = (orgId.slice(-5) || "00000").padStart(5, '0');
            const now = new Date();
            const dd = String(now.getDate()).padStart(2, '0');
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const yy = String(now.getFullYear()).slice(-2);
            const fullYear = now.getFullYear();
            const hh = String(now.getHours()).padStart(2, '0');
            const mi = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const xx = String(Math.floor(Math.random() * 100)).padStart(2, '0');
            const profileId = `POR_${nnnnn}_${dd}${mm}${yy}_${hh}${mi}${ss}_${xx}`;
            document.getElementById('u_profileId').value = profileId;
            const timeUpdate = `${dd}/${mm}/${fullYear} ${hh}:${mi}:${ss}`;
            document.getElementById('u_updateTime').value = timeUpdate;
            if (currentUser && currentUser.userId) {
                document.getElementById('u_account').value = currentUser.userId;
            }
            const payload = {};
            document.querySelectorAll('#profileForm [data-col]').forEach(el => {
                payload[el.getAttribute('data-col')] = el.value;
            });
            // Ghi danh s√°ch FolderID (c√°ch nhau d·∫•u ph·∫©y)
            payload.FolderID = selectedFolderIds;
            const fi = document.getElementById('fileInput');
            if (fi.files.length > 0) {
                const file = fi.files[0];
                const extension = file.name.includes('.') ? "." + file.name.split('.').pop() : "";
                const newFileName = profileId + extension;
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                payload.fileBase64 = base64;
                payload.mimeType = file.type || "application/octet-stream";
                payload.fileName = newFileName;
            }
            try {
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify([payload]) });
                showToast("L∆∞u th√†nh c√¥ng!", "success");
                const pData = await fetchGoogleSheet('Profile');
                DATA_STORE.profiles = pData; renderFolders();
                e.target.reset();
                document.querySelectorAll('#folderOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelector('.selected-text').innerText = 'Ch·ªçn h·ªì s∆°...';
                document.getElementById('dropzone').classList.remove('has-file');
                document.getElementById('file-status').innerText = "Ch∆∞a c√≥ file n√†o";
                closeUploadModal();
            } catch (err) { showToast("L·ªói: " + err.message, "error"); }
            finally { btn.disabled = false; btn.innerText = "L∆ØU H·ªí S∆†"; }
        };
        function showToast(txt, type) {
            let color = type === "error" ? "#d93025" : (type === "info" ? "#333" : "#0061d5");
            Toastify({ text: txt, duration: 6000, gravity: "bottom", position: "right", className: "toast-custom", style: { background: color } }).showToast();
        }
        function attachResizers() {
            document.querySelectorAll('.resizer').forEach(r => {
                r.onmousedown = (e) => {
                    const th = r.parentElement; const startX = e.pageX; const startW = th.offsetWidth;
                    const move = (ev) => { th.style.width = (startW + (ev.pageX - startX)) + 'px'; };
                    const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                    document.addEventListener('mousemove', move); document.addEventListener('mouseup', stop);
                };
            });
        }
        function toggleDropdown(el) {
            const container = el.nextElementSibling;
            if (openDropdown && openDropdown !== container) {
                openDropdown.style.display = 'none';
            }
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
            openDropdown = container.style.display === 'block' ? container : null;
        }
        document.addEventListener('click', (e) => {
            if (openDropdown && !openDropdown.contains(e.target) && !e.target.closest('.select-box')) {
                openDropdown.style.display = 'none';
                openDropdown = null;
            }
        });
        bootstrap();
    </script>
</body>
</html>